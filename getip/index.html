<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  	<meta property="og:title" content=" Golang 获取 IP 寄存器内容 &middot;  NOTHING" />
  	<meta property="og:site_name" content="NOTHING" />
  	<meta property="og:url" content="https://soyum2222.github.io/getip/" />
    
    
  	<meta property="og:type" content="article" />

    <meta property="og:article:published_time" content="2020-08-27T23:04:25&#43;08:00" />

    
    

  <title>
     Golang 获取 IP 寄存器内容 &middot;  NOTHING
  </title>

    <meta name="description" content="hi the world" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://soyum2222.github.io/images/favicon.ico">
	  <link rel="apple-touch-icon" href="https://soyum2222.github.io/images/apple-touch-icon.png" />
    
    <link rel="stylesheet" type="text/css" href="https://soyum2222.github.io/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400|Inconsolata" />


    
      
          <link href="https://soyum2222.github.io/index.xml" rel="alternate" type="application/rss+xml" title="NOTHING" />
      
      
    
    <meta name="generator" content="Hugo 0.74.3" />

    <link rel="canonical" href="https://soyum2222.github.io/getip/" />

     
</head>
<body class="nav-closed">
<div id="particles-js"></div>
  


 <div class="site-wrapper">



<header class="main-header " style="background-image: url(https://soyum2222.github.io/images/user.jpg)">

    <nav class="main-nav overlay clearfix">
        
            <a class="blog-logo" href="https://soyum2222.github.io/"><img src="https://soyum2222.github.io/images/user.png" alt="Blog Logo" /></a>
        
        
    </nav>
<div class="vertical">
        <div class="main-header-content inner">
            <h1 class="page-title">
              <a class="btn-bootstrap-2" href="#content">NOTHING</a>
          </h1>
          <h2 class="page-description">hi the world</h2>
        </div>
</div>
    <a class="scroll-down icon-arrow-left" href="#content"><span class="hidden">Scroll Down</span></a>
</header>

  <main id="content" class="content" role="main">


  <article class="post ">

    <header class="post-header">
        <h1 class="post-title">Golang 获取 IP 寄存器内容</h1>
        <section class="post-meta">
        
         
        </section>
    </header>

    <section class="post-content">
      <p>之前用C写过一个调度器，想用Go也写一次，正好最近在学习Plan9汇编，趁机巩固一下。</p>
<p>先理清楚基本思路。因为不能直接对IP寄存器做操作，所以无法直接通过 MOVQ IP，AX 这种方式得到IP的值。</p>
<p>但是总所周知，CALL 指令等价于 PUSH IP ，jmp XXX 。所以我们可以通过CALL指令过通过SP寄存器拿到IP的值。</p>
<p>基本思路很简单</p>
<p>但是和C语言有一些细微的差别</p>
<p>C版本</p>
<pre><code>int64 getrip() {
    register int64 ip;
    asm volatile (
    &quot;movq 0x10(%%rsp), %0\n\t&quot;
    :&quot;=r&quot;(ip)
    );
    return ip;
}

</code></pre><p>Go plan9 版本</p>
<pre><code>TEXT ·getip(SB),$0
	MOVQ (SP) ,AX
	MOVQ AX,ret+0(FP)
	RET
</code></pre><p>C版本要比GO版本SP多偏移一个8字节。</p>
<p>为啥呢?  我照着C版本SP偏移8字节取拿IP，结果就是debug了一个下午。</p>
<p>反编译两个版本看一下</p>
<p>C</p>
<pre><code>getrip:
.LFB0:
      .cfi_startproc
      pushq   %rbp
      .cfi_def_cfa_offset 16
      .cfi_offset 6, -16
      movq    %rsp, %rbp
      .cfi_def_cfa_register 6
      pushq   %rbx
      .cfi_offset 3, -24
#APP
# 9 &quot;main.c&quot; 1
      movq 0x10(%rsp), %rax

# 0 &quot;&quot; 2
#NO_APP
      movq    %rax, %rbx
      movq    %rbx, %rax
      popq    %rbx
      popq    %rbp
      .cfi_def_cfa 7, 8
      ret
      .cfi_endproc
</code></pre><p>GO</p>
<pre><code>TEXT main.getip(SB) /mnt/d/gopath/src/touchingfish/plan9/getip/getip.s
      getip.s:4       0x4addf0*       488b442408      mov rax, qword ptr [rsp+0x8]
      getip.s:5       0x4addf5        4889442408      mov qword ptr [rsp+0x8], rax
      getip.s:6       0x4addfa        c3              ret
</code></pre><p>看到是因为C在调用方法的时候，因为是内嵌的汇编，所以他会有正常构建栈的过程，开头比go多了一个push %rbp。
Go中如果是手写汇编方法，这一部分是需要在TEXT .getip(SB),$0-0  这个开后指定栈的大小。我指定的是0 所以SP处就是IP的位子。</p>
<p>值得注意的是，如果把TEXT .getip(SB),$0-0 改成了TEXT .getip(SB),$8-0，这个地方的偏移量又会变成16，不但栈扩充8字节 还有个push BP的过程，又是8字节。(((φ(◎ロ◎;)φ)))</p>
<pre><code>TEXT main.getip(SB) /mnt/d/gopath/src/touchingfish/plan9/getip/getip.s  
      getip.s:3       0x4addf0*       4883ec10        sub rsp, 0x10
      getip.s:3       0x4addf4        48896c2408      mov qword ptr [rsp+0x8], rbp
      getip.s:3       0x4addf9        488d6c2408      lea rbp, ptr [rsp+0x8]
      getip.s:4       0x4addfe        488b442408      mov rax, qword ptr [rsp+0x8]
      getip.s:5       0x4ade03        4889442418      mov qword ptr [rsp+0x18], rax
      getip.s:6       0x4ade08        488b6c2408      mov rbp, qword ptr [rsp+0x8]
      getip.s:1       0x4ade0d        4883c410        add rsp, 0x10
      getip.s:1       0x4ade11        c3              ret
</code></pre><p>其实从这个地方可以得到一个信息 ，FP伪寄存器其实是不在当前方法栈内的。他在caller的栈内。</p>
<p>其实这里也可以改成</p>
<pre><code>TEXT ·getip(SB),$0x8-0
  MOVQ ip-8(FP) ,AX
  MOVQ AX,ret+0(FP)
  RET
</code></pre><p>FP伪寄存器是指向IP的位置前8位的，也就是返回值和参数的地址的末尾。这里 推荐 <a href="https://xargin.com/plan9-assembly/">https://xargin.com/plan9-assembly/</a> 曹大的文章</p>

    </section>


  <footer class="post-footer">


    
    <figure class="author-image">

        <a class="img" href="https://soyum2222.github.io/" style="background-image: url(https://soyum2222.github.io/images/user.png)"><span class="hidden">soyum</span></a>
    </figure>
    

    <section class="author">

  <p>soyum</p>
  

</section>


    
    <section class="share">
      <h4>Share this page</h4>
      <a class="icon-twitter" style="font-size: 1.4em" href="https://twitter.com/share?text=Golang%20%e8%8e%b7%e5%8f%96%20IP%20%e5%af%84%e5%ad%98%e5%99%a8%e5%86%85%e5%ae%b9&amp;url=https%3a%2f%2fsoyum2222.github.io%2fgetip%2f"
          onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <span class="hidden">Twitter</span>
      </a>
      <a class="icon-facebook" style="font-size: 1.4em" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fsoyum2222.github.io%2fgetip%2f"
          onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <span class="hidden">Facebook</span>
      </a>
      <a class="icon-google-plus" style="font-size: 1.4em" href="https://plus.google.com/share?url=https%3a%2f%2fsoyum2222.github.io%2fgetip%2f"
         onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
          <span class="hidden">Google+</span>
      </a>
    </section>
    

    
    
    

  </footer>
</article>

</main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">NOTHING</a> </section>
        
        <section class="poweredby">Proudly generated by <a class="icon-hugo" href="https://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/syui/hugo-theme-air">hugo-theme-air</a> theme</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="https://soyum2222.github.io/js/jquery.js"></script>
    <script type="text/javascript" src="https://soyum2222.github.io/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://soyum2222.github.io/js/index.js"></script>
    <script src="https://soyum2222.github.io/js/particles.min.js"></script>
    <script src="https://soyum2222.github.io/js/particles.js"></script>  

</body>
</html>

